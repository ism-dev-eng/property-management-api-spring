# .github/workflows/deploy-test.yml
name: CD - Deploy to TEST

on:
  push:
    tags:
      - 'v*.*.*-rc*'  # Release candidate tags
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., main-abc123 or test-latest)'
        required: true
        default: 'test-latest'

permissions:
  contents: write
  packages: read

jobs:
  update-and-deploy:
    name: Update TEST Configuration
    runs-on: ubuntu-latest
    environment: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Determine image tag
      id: image-tag
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
        else
          TAG="${{ github.ref_name }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
        fi
        echo "ðŸ“¦ Image tag: ${{ steps.image-tag.outputs.tag }}"
    
    - name: Verify image exists in GHCR
      run: |
        echo "ðŸ” Verifying image exists..."
        # Note: This would require GHCR API access or skip if image doesn't exist yet
        echo "Image tag: ${{ steps.image-tag.outputs.tag }}"
        echo "Image: ghcr.io/${{ github.repository_owner }}/property-management-api:${{ steps.image-tag.outputs.tag }}"
    
    - name: Update Kustomization with image tag
      run: |
        echo "ðŸ“ Updating kustomization.yaml..."
        sed -i "s|newTag:.*|newTag: ${{ steps.image-tag.outputs.tag }}|" k8s/overlays/test/kustomization.yaml
        
        # Show what changed
        echo "Updated kustomization.yaml:"
        grep -A 2 "images:" k8s/overlays/test/kustomization.yaml
    
    - name: Validate configuration
      run: |
        echo "âœ… Validating Kustomize configuration..."
        kubectl kustomize k8s/overlays/test
        echo "âœ… Configuration is valid!"
    
    - name: Commit and push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add k8s/overlays/test/kustomization.yaml
        git diff --cached k8s/overlays/test/kustomization.yaml || true
        git commit -m "chore: update TEST image tag to ${{ steps.image-tag.outputs.tag }} [skip ci]" || echo "No changes to commit"
        git push
    
    - name: Deployment summary
      run: |
        echo "## ðŸš€ TEST Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag:** \`${{ steps.image-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Image:** \`ghcr.io/${{ github.repository_owner }}/property-management-api:${{ steps.image-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace:** \`property-management-test\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ArgoCD Application:** \`property-management-test\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ArgoCD will automatically sync within 3 minutes." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Verify deployment:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "kubectl get application property-management-test -n argocd" >> $GITHUB_STEP_SUMMARY
        echo "kubectl get all -n property-management-test" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY