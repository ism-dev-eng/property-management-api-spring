# .github/workflows/deploy-test.yml
name: CD - Deploy to TEST

on:
  push:
    tags:
      - 'v*.*.*-rc*'  # Release candidate tags
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'test-latest'

permissions:
  contents: write  # Need write to update kustomization.yaml
  packages: read

jobs:
  update-and-deploy:
    name: Update TEST Configuration
    runs-on: ubuntu-latest
    environment: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Determine image tag
      id: image-tag
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
        else
          TAG="${{ github.ref_name }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
        fi
        echo "ðŸ“¦ Image tag: ${{ steps.image-tag.outputs.tag }}"
    
    - name: Update Kustomization with image tag
      run: |
        # Update image tag in kustomization.yaml
        sed -i "s|newTag:.*|newTag: ${{ steps.image-tag.outputs.tag }}|" k8s/overlays/test/kustomization.yaml
        
        # Commit and push (triggers ArgoCD sync)
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add k8s/overlays/test/kustomization.yaml
        git commit -m "chore: update TEST image tag to ${{ steps.image-tag.outputs.tag }}" || exit 0
        git push
    
    - name: Validate configuration
      run: |
        kubectl kustomize k8s/overlays/test
        echo "âœ… Configuration valid!"